<!--
@element date-select

`<date-select>` is a date selector widget inspired inspired by the date picker in iOS

Example usage:

    <date-select year="{{ year }}" month="{{ month }} year="{{ year }}"></date-select>

-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../wheel-select/wheel-select.html">

<polymer-element name="date-select">

<template>
    <style>
        :host {
            display: block;
            perspective: 1000px;
            text-align: center;
            min-width: 235px;
        }

        wheel-select {
            perspective: 0;
        }

        wheel-select::shadow .option {
            padding: 0 10px;
        }

        .days::shadow .option {
            text-align: right;
        }

        .months::shadow .option, .years::shadow .option {
            text-align: left;
        }

        .days {
            width: 60px;
        }

        .months {
            min-width: 100px;
            max-width: 150px;
        }

        .years {
            width: 75px;
        }
    </style>

    <div hidden?="{{ cont }}" layout horizontal center-justified>
        <wheel-select options="{{ days }}" value="{{ day }}" class="days" repeat></wheel-select>
        <wheel-select options="{{ months }}" value="{{ month }}" class="months" repeat flex></wheel-select>
        <wheel-select id="yearSelect" options="{{ years }}" value="{{ year }}" class="years"></wheel-select>
    </div>

    <div hidden?="{{ !cont }}">
        <wheel-select options="{{ dateOptions }}" id="contSelect"
            on-select="{{ dateSelected }}"></wheel-select>
    </div>

</template>

<script>
(function() {
    'use strict';

    function daysInMonth(year, month) {
        return new Date(year, month + 1, 0).getDate();
    }

    Polymer({

        // TODO: Find a way to provide localized month names
        months: [
            { label: 'January', value: 0 },
            { label: 'February', value: 1 },
            { label: 'March', value: 2 },
            { label: 'April', value: 3 },
            { label: 'May', value: 4 },
            { label: 'June', value: 5 },
            { label: 'July', value: 6 },
            { label: 'August', value: 7 },
            { label: 'September', value: 8 },
            { label: 'October', value: 9 },
            { label: 'November', value: 10 },
            { label: 'December', value: 11 },
        ],

        publish: {
            /**
             * @attribute day
             * The selected day. If not specified, defaults to the current day.
             */
            day: 0,
            /**
             * @attribute month
             * The selected month. If not specified, defaults to the current month.
             * NOTE: This value is 0-based to be consistent with the native `Date` object.
             * I.e. `0` corresponds to January, `1` corresponds to February and so on.
             */
            month: 0,
            /**
             * @attribute year
             * The selected year. If not specified, defaults to the current year.
             */
            year: 0,
            cont: {
                value: false,
                reflect: true
            }
        },

        years: function(i) {
            var currYear = new Date().getFullYear();
            return currYear + i;
        },

        created: function() {
            var currDate = new Date();
            var currYear = currDate.getFullYear();
            this.year = this.year || currYear;
            this.month = this.month || currDate.getMonth();
            this.day = this.day || currDate.getDate();
            this.updateDays();
        },

        updateDays: function() {
            var nDays = daysInMonth(this.year, this.month);
            var days = [];
            for (var d = 1; d <= nDays; d++) {
                days.push(d);
            }
            this.day = Math.max(1, Math.min(nDays, this.day));
            this.days = days;
        },

        /**
         * @method getDate
         * Returns a `Date` object initialized with the selected year, month and day
         */
        getDate: function() {
            return new Date(this.year, this.month, this.day);
        },

        dateOptions: function(i) {
            var date = new Date();
            date.setDate(date.getDate() + i);
            return {
                value: date,
                label: date.toLocaleDateString()
            };
        },

        dateSelected: function(e, opt) {
            var d = opt.value;
            this.year = d.getFullYear();
            this.month = d.getMonth();
            this.day = d.getDate();
        },

        updateContSelect: function() {
            var currDate = new Date();
            var selectedDate = this.getDate();
            var diff = selectedDate.getTime() - currDate.getTime();
            var i = Math.ceil(diff / 24 / 60 / 60 / 1000);
            this.$.contSelect.selectedIndex = i;
        },

        updateYearSelect: function() {
            var currYear = new Date().getFullYear();
            this.$.yearSelect.selectedIndex = this.year - currYear;
        },

        yearChanged: function() {
            this.updateYearSelect();
            this.updateDays();
            this.updateContSelect();
        },

        monthChanged: function() {
            this.updateDays();
            this.updateContSelect();
        },

        dayChanged: function() {
            this.updateContSelect();
        }

    });
})(Polymer, moment);
</script>

</polymer-element>
